---
phase: 04-proactive-autonomy-ux
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.openclaw/openclaw.json
  - ~/.openclaw/workspace-juancho/heartbeat.md
autonomous: true

must_haves:
  truths:
    - "Heartbeat cron checks work status periodically and determines next action"
    - "Proactivity schedule is configurable (active hours, frequency, intensity)"
    - "Agent transitions to next phase automatically when tests pass"
    - "When blocked, agent reports via Telegram and awaits input"
    - "HEARTBEAT_OK token prevents infinite loop when idle"
  artifacts:
    - path: "~/.openclaw/openclaw.json"
      provides: "Heartbeat configuration with schedule, active hours, delivery target"
      contains: "heartbeat"
    - path: "~/.openclaw/workspace-juancho/heartbeat.md"
      provides: "Heartbeat behavior protocol for proactive phase execution"
      min_lines: 60
  key_links:
    - from: "~/.openclaw/workspace-juancho/heartbeat.md"
      to: ".planning/STATE.md"
      via: "Read STATE.md to determine current phase status"
      pattern: "STATE\\.md"
    - from: "~/.openclaw/openclaw.json"
      to: "heartbeat.md"
      via: "heartbeat.prompt references workspace file"
      pattern: "heartbeat\\.md"
---

<objective>
Configure OpenClaw's heartbeat system for proactive autonomous execution. Juancho checks project state periodically, determines next action (execute phase, verify phase, plan next phase), and reports status via Telegram. When blocked, it reports the blocker and waits.

Purpose: This is the core of Juancho's proactive autonomy -- the heartbeat is what makes Juancho work WITHOUT being prompted. It reads .planning/STATE.md, decides what to do, and does it.
Output: Configured heartbeat in openclaw.json + heartbeat behavior protocol file
</objective>

<execution_context>
@/Users/didac/.claude/get-shit-done/workflows/execute-plan.md
@/Users/didac/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/didac/Juancho/.planning/PROJECT.md
@/Users/didac/Juancho/.planning/ROADMAP.md
@/Users/didac/Juancho/.planning/STATE.md
@/Users/didac/Juancho/.planning/phases/04-proactive-autonomy-ux/04-RESEARCH.md
@/Users/didac/.openclaw/openclaw.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure heartbeat in openclaw.json</name>
  <files>~/.openclaw/openclaw.json</files>
  <action>
Update ~/.openclaw/openclaw.json to add heartbeat configuration under agents.defaults. The file currently has agents.list and bindings sections. Add agents.defaults with heartbeat config.

Add the following configuration:

```json5
{
  "agents": {
    "defaults": {
      "heartbeat": {
        "enabled": true,
        "every": "5m",
        "prompt": "heartbeat.md",
        "target": "telegram",
        "ackMaxChars": 200,
        "activeHours": {
          "start": "08:00",
          "end": "18:00",
          "timezone": "user"
        }
      },
      "userTimezone": "Europe/Madrid"
    },
    "list": [... existing ...]
  },
  "bindings": [... existing ...]
}
```

Key constraints:
- Preserve ALL existing content (agents.list, bindings)
- Use "user" for timezone (NOT system default -- avoids VPS timezone mismatch, see Pitfall 6 in research)
- Set userTimezone to "Europe/Madrid" (user's timezone)
- every: "5m" balances responsiveness with API costs
- ackMaxChars: 200 keeps status updates brief for Telegram
- target: "telegram" delivers heartbeat output to Telegram channel
- prompt: "heartbeat.md" references the workspace file created in Task 2
  </action>
  <verify>
Read ~/.openclaw/openclaw.json and confirm:
1. Valid JSON (parse with jq or node -e)
2. agents.defaults.heartbeat.enabled is true
3. agents.defaults.heartbeat.every is "5m"
4. agents.defaults.heartbeat.prompt is "heartbeat.md"
5. agents.defaults.heartbeat.activeHours.timezone is "user"
6. agents.list and bindings still intact
  </verify>
  <done>openclaw.json contains valid heartbeat configuration with 5-minute interval, active hours 08:00-18:00 Europe/Madrid, delivering to Telegram</done>
</task>

<task type="auto">
  <name>Task 2: Create heartbeat behavior protocol</name>
  <files>~/.openclaw/workspace-juancho/heartbeat.md</files>
  <action>
Create ~/.openclaw/workspace-juancho/heartbeat.md -- the heartbeat behavior protocol that tells Juancho what to do on each heartbeat tick.

The file must implement this decision tree:

1. **Read project state**: Read .planning/STATE.md to get current phase, plan, and status
2. **Check if already executing**: If STATE.md shows "Status: executing", respond HEARTBEAT_OK (prevents infinite loop -- Pitfall 1 from research)
3. **Determine next action** based on state:
   - If current phase has unexecuted plans -> invoke /execute-phase {N}
   - If phase executed but not verified -> invoke /verify-phase {N}
   - If phase verified and complete -> check for next phase in ROADMAP.md
     - If next phase exists and has plans -> invoke /execute-phase {N+1}
     - If next phase exists but no plans -> report "Phase {N+1} needs planning" and HEARTBEAT_OK
     - If no more phases -> report "All phases complete" and HEARTBEAT_OK
   - If blocked (STATE.md shows blockers) -> report blocker via Telegram, suggest alternatives, HEARTBEAT_OK
4. **Status update format**:
   - Action taken: Brief description of what was started
   - Idle: HEARTBEAT_OK (suppresses delivery)
   - Blocked: Report blocker with context
5. **Gate checks before action**:
   - Verify .planning/ directory exists (project initialized)
   - Verify ROADMAP.md exists (phases defined)
   - If missing: report "No active project" and HEARTBEAT_OK

Key constraints:
- MUST use HEARTBEAT_OK token when idle (prevents unnecessary Telegram messages)
- MUST check execution state to prevent re-triggering running work (infinite loop prevention)
- MUST stay under 350 lines / 15k chars (skill file limits)
- Include clear section headers for each decision branch
- Reference /gsd: command format for skill invocations
- When blocked, suggest researching alternatives or working on unblocked items (PROA-04)
  </action>
  <verify>
1. File exists at ~/.openclaw/workspace-juancho/heartbeat.md
2. Contains HEARTBEAT_OK token usage
3. Contains STATE.md reading logic
4. Contains execution state check (prevent re-trigger)
5. Contains decision tree for execute/verify/plan transitions
6. File is under 350 lines: wc -l < 350
7. File is under 15000 chars: wc -c < 15000
  </verify>
  <done>heartbeat.md exists with complete decision tree: reads STATE.md, prevents infinite loops via HEARTBEAT_OK, triggers phase execution/verification/transition, reports blockers, stays within skill file limits</done>
</task>

</tasks>

<verification>
1. openclaw.json is valid JSON with heartbeat config and existing agent/binding preserved
2. heartbeat.md implements full decision tree with idle/action/blocked states
3. heartbeat.md uses HEARTBEAT_OK for idle state (no unnecessary messages)
4. heartbeat.md checks execution state before acting (no infinite loops)
5. Both files within size limits
</verification>

<success_criteria>
- Heartbeat configured to check every 5 minutes during 08:00-18:00 Europe/Madrid
- Heartbeat protocol reads STATE.md, determines action, executes or reports
- Idle state uses HEARTBEAT_OK (no Telegram noise)
- Running state detection prevents re-triggering (no infinite loops)
- Blocked state reports blocker and suggests alternatives
- Phase transitions happen automatically when previous phase verified
</success_criteria>

<output>
After completion, create `.planning/phases/04-proactive-autonomy-ux/04-01-SUMMARY.md`
</output>
